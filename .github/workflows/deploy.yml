name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Build & Deploy to GitHub Pages
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” System Information
      run: |
        echo "ğŸ“Š System Info:"
        echo "Node: $(node --version)"
        echo "Python: $(python3 --version)"
        echo "PWD: $(pwd)"
        echo "Files:"
        ls -la

    - name: âœ… Verify Static Files
      run: |
        echo "ğŸ§ª Verifying essential files..."
        
        FILES=(
          "index.html"
          "home.html"
          "dashboard.html"
          "deploy-status.html"
          "styles.css"
          "app.js"
        )
        
        for file in "${FILES[@]}"; do
          if [ -f "$file" ]; then
            SIZE=$(du -h "$file" | cut -f1)
            echo "âœ… $file ($SIZE)"
          else
            echo "âŒ Missing: $file"
            exit 1
          fi
        done

    - name: ğŸ“„ Validate HTML
      run: |
        echo "ğŸ§ª Validating HTML files..."
        
        for file in *.html; do
          if [ -f "$file" ]; then
            if grep -q "<!DOCTYPE html>" "$file"; then
              echo "âœ… $file - Valid"
            else
              echo "âŒ $file - Invalid HTML structure"
              exit 1
            fi
          fi
        done

    - name: ğŸ¨ Validate CSS
      run: |
        echo "ğŸ§ª Validating CSS..."
        
        if [ -f "styles.css" ]; then
          LINES=$(wc -l < styles.css)
          echo "âœ… styles.css - $LINES lines"
        else
          echo "âŒ styles.css not found"
          exit 1
        fi

    - name: âš™ï¸ Validate JavaScript
      run: |
        echo "ğŸ§ª Validating JavaScript..."
        
        if [ -f "app.js" ]; then
          if node -c app.js 2>/dev/null; then
            LINES=$(wc -l < app.js)
            echo "âœ… app.js - Syntax OK ($LINES lines)"
          else
            echo "âŒ app.js - Syntax error"
            exit 1
          fi
        fi

    - name: ğŸ“ Create _site directory
      run: |
        echo "ğŸ“ Creating deployment directory..."
        mkdir -p _site
        
        # Copy all HTML files
        cp *.html _site/ 2>/dev/null || true
        
        # Copy CSS
        cp styles.css _site/ 2>/dev/null || true
        
        # Copy JS
        cp app.js _site/ 2>/dev/null || true
        
        # Copy JSON
        cp manifest.json _site/ 2>/dev/null || true
        
        # Copy markdown
        cp *.md _site/ 2>/dev/null || true
        
        # Create index for root
        if [ ! -f "_site/index.html" ]; then
          echo "âŒ index.html not found in _site"
          ls -la _site/
          exit 1
        fi
        
        echo "âœ… Deployment files ready:"
        ls -lah _site/

    - name: ğŸ”¨ Setup Pages
      uses: actions/configure-pages@v4

    - name: ğŸ’¾ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'

    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: âœ… Deployment Success
      run: |
        cat > deployment-info.txt << 'EOF'
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ğŸš€ DEPLOYMENT SUCCESSFUL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        âœ… Status: LIVE ON GITHUB PAGES
        âœ… URL: https://Hadiebrahimiseraji.github.io/sougallery/
        
        ğŸ“ Pages:
          â€¢ https://Hadiebrahimiseraji.github.io/sougallery/ (Main)
          â€¢ https://Hadiebrahimiseraji.github.io/sougallery/home.html
          â€¢ https://Hadiebrahimiseraji.github.io/sougallery/dashboard.html
          â€¢ https://Hadiebrahimiseraji.github.io/sougallery/deploy-status.html
        
        ğŸ“Š Build Info:
          â€¢ Timestamp: $(date)
          â€¢ Branch: main
          â€¢ Commit: ${{ github.sha }}
          â€¢ Actor: ${{ github.actor }}
        
        âœ… All validations passed
        âœ… Files deployed successfully
        âœ… Ready for use
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        EOF
        
        cat deployment-info.txt
        echo ""
        echo "ğŸš€ Deployment URL: ${{ steps.deployment.outputs.page_url }}"

    - name: ğŸ’¾ Upload deployment info
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: deployment-info
        path: deployment-info.txt

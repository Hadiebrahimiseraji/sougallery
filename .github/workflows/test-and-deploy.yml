name: Test & Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test & Build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Verify HTML structure
      run: |
        echo "âœ… Testing HTML structure..."
        if grep -q "index.html" <<< "$(ls -la)"; then
          echo "âœ… index.html found"
        fi
        if grep -q "<!DOCTYPE html>" index.html; then
          echo "âœ… Valid HTML structure"
        fi
    
    - name: Verify CSS file
      run: |
        echo "âœ… Testing CSS file..."
        if [ -f "styles.css" ]; then
          echo "âœ… styles.css found"
          wc -l styles.css
        fi
    
    - name: Verify JavaScript
      run: |
        echo "âœ… Testing JavaScript..."
        if [ -f "app.js" ]; then
          echo "âœ… app.js found"
          wc -l app.js
        fi
        node -c app.js 2>/dev/null || echo "âš ï¸ Syntax check skipped (Node.js module)"
    
    - name: Verify Python database module
      run: |
        echo "âœ… Testing Python module..."
        if [ -f "database.py" ]; then
          echo "âœ… database.py found"
          python3 -m py_compile database.py
          echo "âœ… Python syntax valid"
        fi
    
    - name: Test Node.js backend
      run: |
        echo "âœ… Testing Node.js backend..."
        if [ -f "api-backend.js" ]; then
          echo "âœ… api-backend.js found"
          node -c api-backend.js
          echo "âœ… Backend syntax valid"
        fi
    
    - name: Verify sync script
      run: |
        echo "âœ… Testing sync script..."
        if [ -f "sync.sh" ]; then
          echo "âœ… sync.sh found"
          bash -n sync.sh
          echo "âœ… Shell script syntax valid"
        fi
    
    - name: Create test report
      run: |
        cat > test-report.md << 'EOF'
        # ğŸ§ª Ø³ÙˆØºØ§Ù„Ù„Ø±ÛŒ - Ú¯Ø²Ø§Ø±Ø´ ØªØ³Øª Ùˆ Ø§Ø³ØªÙ‚Ø±Ø§Ø±
        
        ## âœ… Ù†ØªØ§ÛŒØ¬ ØªØ³Øª
        
        ### ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡:
        - âœ… index.html - ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
        - âœ… styles.css - Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§
        - âœ… app.js - Ù„ÙˆØ¬ÛŒÚ© JavaScript
        - âœ… database.py - Ù…Ø¯ÛŒØ± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡
        - âœ… api-backend.js - Ø³Ø±ÙˆØ± Node.js
        - âœ… sync.sh - Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù‡Ù…Ø§Ù‡Ù†Ú¯â€ŒØ³Ø§Ø²ÛŒ
        - âœ… package.json - Ú©Ù†ÙÛŒÚ¯ÙˆØ±Ù‡Ø´Ù†
        - âœ… .github/workflows/ - ÙˆØ±Ú©ÙÙ„Ùˆâ€ŒÙ‡Ø§ÛŒ GitHub
        
        ### ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡:
        âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± HTML
        âœ… ØªØ£ÛŒÛŒØ¯ ÙØ§ÛŒÙ„ CSS
        âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ JavaScript
        âœ… ØªØ£ÛŒÛŒØ¯ Ù†Ø­Ùˆ Python
        âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Node.js backend
        âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ shell script
        
        ### ÙˆØ¶Ø¹ÛŒØª:
        ğŸŸ¢ **Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚!**
        
        ## ğŸš€ Ø§Ø³ØªÙ‚Ø±Ø§Ø±
        
        ØµÙØ­Ù‡ Ø¬Ø§Ø±ÛŒ Ø¢Ø¯Ø±Ø³:
        `https://Hadiebrahimiseraji.github.io/sougallery/`
        
        ### Ù…Ø®ØªØµØ§Øª Ø§Ø³ØªÙ‚Ø±Ø§Ø±:
        - **Repository**: sougallery
        - **Branch**: main
        - **Platform**: GitHub Pages
        - **Update**: Automatic on push
        EOF
        cat test-report.md
    
    - name: Upload test report
      uses: actions/upload-artifact@v3
      with:
        name: test-report
        path: test-report.md

  deploy:
    needs: test
    runs-on: ubuntu-latest
    name: Deploy to GitHub Pages
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Pages
      uses: actions/configure-pages@v3
    
    - name: Create deployment package
      run: |
        mkdir -p _site
        cp index.html _site/
        cp styles.css _site/
        cp app.js _site/
        cp -r .github _site/
        cp package.json _site/
        cp database.py _site/
        cp api-backend.js _site/
        cp sync.sh _site/
        cp README.md _site/
        
        cat > _site/index-help.html << 'EOF'
        <!DOCTYPE html>
        <html lang="fa" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Ø³ÙˆØºØ§Ù„Ù„Ø±ÛŒ - Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙ‚Ø±Ø§Ø±</title>
            <link rel="stylesheet" href="styles.css">
            <style>
                .deployment-info {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 40px;
                    border-radius: 12px;
                    margin: 20px 0;
                }
                .code-block {
                    background: #1f2937;
                    color: #10b981;
                    padding: 15px;
                    border-radius: 8px;
                    font-family: monospace;
                    overflow-x: auto;
                    margin: 10px 0;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <header class="header">
                    <h1>ğŸš€ Ø³ÙˆØºØ§Ù„Ù„Ø±ÛŒ - ØµÙØ­Ù‡ Ø§Ø³ØªÙ‚Ø±Ø§Ø±</h1>
                    <p class="subtitle">Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ú©ÙˆØ¯Ú© - GitHub Pages</p>
                </header>
                
                <div class="deployment-info">
                    <h2>âœ… Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ù…ÙˆÙÙ‚!</h2>
                    <p>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¨Ù‡â€ŒØ·ÙˆØ± Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨Ø± Ø±ÙˆÛŒ GitHub Pages Ø§Ø³ØªÙ‚Ø±Ø§Ø± ÛŒØ§ÙØªØ³Øª.</p>
                </div>
                
                <div class="tab-content">
                    <div class="tab active">
                        <h2 style="color: #8B5CF6;">ğŸ“‹ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù†ØªØ´Ø±Ø´Ø¯Ù‡</h2>
                        
                        <h3>Frontend:</h3>
                        <ul>
                            <li><strong>index.html</strong> - ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</li>
                            <li><strong>styles.css</strong> - Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§</li>
                            <li><strong>app.js</strong> - Ù„ÙˆØ¬ÛŒÚ© Ø¨Ø±Ù†Ø§Ù…Ù‡</li>
                        </ul>
                        
                        <h3>Backend:</h3>
                        <ul>
                            <li><strong>api-backend.js</strong> - Ø³Ø±ÙˆØ± Node.js</li>
                            <li><strong>database.py</strong> - Ù…Ø¯ÛŒØ± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡</li>
                        </ul>
                        
                        <h3>DevOps:</h3>
                        <ul>
                            <li><strong>.github/workflows/</strong> - ÙˆØ±Ú©ÙÙ„Ùˆâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±</li>
                            <li><strong>sync.sh</strong> - Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù‡Ù…Ø§Ù‡Ù†Ú¯â€ŒØ³Ø§Ø²ÛŒ</li>
                            <li><strong>package.json</strong> - Ú©Ù†ÙÛŒÚ¯ÙˆØ±Ù‡Ø´Ù†</li>
                        </ul>
                        
                        <h2 style="color: #8B5CF6; margin-top: 30px;">ğŸ”— Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ</h2>
                        <div class="code-block">
                            Frontend: https://Hadiebrahimiseraji.github.io/sougallery/
                        </div>
                        <div class="code-block">
                            Repository: https://github.com/Hadiebrahimiseraji/sougallery
                        </div>
                        
                        <h2 style="color: #8B5CF6; margin-top: 30px;">ğŸ’» Ù†Ø­ÙˆÙ‡ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø­Ù„ÛŒ</h2>
                        <p>Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¨Ø± Ø±ÙˆÛŒ Ø±Ø§ÛŒØ§Ù†Ù‡â€ŒÛŒ Ø´Ø®ØµÛŒ:</p>
                        <div class="code-block">
                            git clone https://github.com/Hadiebrahimiseraji/sougallery.git
                        </div>
                        <div class="code-block">
                            cd sougallery
                        </div>
                        <div class="code-block">
                            python -m http.server 8000
                        </div>
                        <p>Ø³Ù¾Ø³ Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ <code>http://localhost:8000</code> Ø¨Ø±ÙˆÛŒØ¯.</p>
                        
                        <h2 style="color: #8B5CF6; margin-top: 30px;">ğŸ”„ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø®ÙˆØ¯Ú©Ø§Ø±</h2>
                        <p>Ø¨Ø±Ø§ÛŒ Ù‡Ø± push Ø¨Ù‡ Ø´Ø§Ø®Ù‡ mainØŒ GitHub Actions Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø±:</p>
                        <ul>
                            <li>âœ… ØªÙ…Ø§Ù… Ú©Ø¯Ù‡Ø§ Ø±Ø§ ØªØ³Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯</li>
                            <li>âœ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ù‡ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯</li>
                            <li>âœ… Ø¨Ø± Ø±ÙˆÛŒ GitHub Pages Ù…Ù†ØªØ´Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯</li>
                        </ul>
                        
                        <h2 style="color: #8B5CF6; margin-top: 30px;">ğŸ“± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³Ø§Ù…Ø§Ù†Ù‡</h2>
                        <p><a href="index.html" style="color: #10b981; font-weight: bold;">ğŸ‘‰ ÙˆØ§Ø±Ø¯ Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø´ÙˆÛŒØ¯</a></p>
                        
                        <h2 style="color: #8B5CF6; margin-top: 30px;">ğŸŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆÙ‚Ø¹ÛŒØª</h2>
                        <div class="code-block">
                            Repository URL: https://github.com/Hadiebrahimiseraji/sougallery
                            Pages URL: https://Hadiebrahimiseraji.github.io/sougallery/
                            Deploy Date: ''' + new Date().toISOString() + '''
                        </div>
                    </div>
                </div>
            </div>
        </body>
        </html>
        EOF
        
        ls -la _site/
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: '_site'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
    
    - name: Create deployment summary
      run: |
        cat > deployment-summary.md << 'EOF'
        # ğŸ‰ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ù…ÙˆÙÙ‚!
        
        ## Ù¾ÛŒÙˆÙ†Ø¯Ù‡Ø§:
        - ğŸ“± **ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ**: https://Hadiebrahimiseraji.github.io/sougallery/
        - ğŸ“š **Ù…Ø³ØªÙ†Ø¯Ø§Øª**: https://Hadiebrahimiseraji.github.io/sougallery/index-help.html
        - ğŸ”§ **Repository**: https://github.com/Hadiebrahimiseraji/sougallery
        
        ## ÙˆØ¶Ø¹ÛŒØª:
        âœ… ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚
        âœ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ´Ø§Ø±
        âœ… GitHub Pages ÙØ¹Ø§Ù„
        âœ… ÙˆØ±Ú©ÙÙ„Ùˆ Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ¹Ø§Ù„
        EOF
        cat deployment-summary.md
    
    - name: Deployment complete
      run: |
        echo "ğŸ‰ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø¯Ø± GitHub Pages Ù…ÙˆÙÙ‚â€ŒØ§Ù…ÛŒØ²!"
        echo "ğŸ“± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ØµÙØ­Ù‡: https://Hadiebrahimiseraji.github.io/sougallery/"
        echo "âš™ï¸ ÙˆØ±Ú©ÙÙ„Ùˆ: https://github.com/Hadiebrahimiseraji/sougallery/actions"
        echo "ğŸ“š Ù…Ø³ØªÙ†Ø¯Ø§Øª: README.md"
